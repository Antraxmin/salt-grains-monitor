name: Deploy to Salt Master

on:
  push:
    branches: [ main ]
  workflow_dispatch:  

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Validate YAML files
      run: |
        echo "YAML íŒŒì¼ ê²€ì¦ ì¤‘..."
        python3 -c "
        import yaml, os, sys
        error_count = 0
        for root, dirs, files in os.walk('srv'):
            for file in files:
                if file.endswith('.sls'):
                    path = os.path.join(root, file)
                    try:
                        with open(path, 'r') as f:
                            yaml.safe_load(f)
                        print(f'âœ… {path}')
                    except Exception as e:
                        print(f'âŒ {path} - ERROR: {e}')
                        error_count += 1

        if error_count > 0:
            print(f'âŒ {error_count}ê°œ íŒŒì¼ì—ì„œ ì˜¤ë¥˜ë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤')
            sys.exit(1)
        else:
            print('âœ… ëª¨ë“  YAML íŒŒì¼ ê²€ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤')
        "
        
    - name: Deploy to Salt Master
      if: github.ref == 'refs/heads/main'
      run: |
        echo "ğŸš€ Salt Master ì„œë²„ ë°°í¬ ì‹œì‘..."
        
        mkdir -p ~/.ssh
        echo "${{ secrets.SALT_MASTER_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H "${{ secrets.SALT_MASTER_HOST }}" >> ~/.ssh/known_hosts
        
        # ì„œë²„ì— ë°°í¬
        ssh -i ~/.ssh/id_rsa "${{ secrets.SALT_MASTER_USER }}"@"${{ secrets.SALT_MASTER_HOST }}" << 'ENDSSH'
          set -e
          
          # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ì„¤ì •
          PROJECT_DIR="/opt/salt-grains-monitor"
          if [ ! -d "$PROJECT_DIR" ]; then
            echo "ğŸ“ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ìƒì„± ì¤‘..."
            sudo mkdir -p "$PROJECT_DIR"
            sudo chown $(whoami):$(whoami) "$PROJECT_DIR"
            cd "$PROJECT_DIR"
            git clone "${{ github.repositoryUrl }}" .
          else
            cd "$PROJECT_DIR"
            echo "ìµœì‹  ì½”ë“œ ì—…ë°ì´íŠ¸ ì¤‘..."
            git fetch origin
            git reset --hard origin/main
          fi
          
          echo "ê¸°ì¡´ ì„¤ì • ë°±ì—… ì¤‘..."
          BACKUP_DIR="/srv/backup/$(date +%Y%m%d_%H%M%S)"
          sudo mkdir -p "$BACKUP_DIR"
          if [ -d "/srv/salt" ]; then
            sudo cp -r /srv/salt "$BACKUP_DIR/" || true
          fi
          if [ -d "/srv/pillar" ]; then
            sudo cp -r /srv/pillar "$BACKUP_DIR/" || true
          fi
          
          # Salt íŒŒì¼ ë™ê¸°í™”
          echo "Salt íŒŒì¼ ë™ê¸°í™” ì¤‘..."
          sudo mkdir -p /srv/salt /srv/pillar /srv/reactor
          sudo rsync -av srv/salt/ /srv/salt/
          sudo rsync -av --exclude="secrets.sls" srv/pillar/ /srv/pillar/
          if [ -d "srv/reactor" ]; then
            sudo rsync -av srv/reactor/ /srv/reactor/
          fi
          
          # ê¶Œí•œ ì„¤ì •
          sudo chown -R root:root /srv
          sudo find /srv -type f -exec chmod 644 {} \;
          sudo find /srv -type d -exec chmod 755 {} \;
          
          # Salt Master ì¬ì‹œì‘
          echo "Salt Master ì¬ì‹œì‘ ì¤‘..."
          sudo systemctl reload salt-master
          
          # ì—°ê²° í…ŒìŠ¤íŠ¸
          echo "ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘..."
          sleep 5
          if timeout 30 sudo salt '*' test.ping; then
            echo "âœ… Minion ì—°ê²°ì— ì„±ê³µí•˜ì˜€ìŠµë‹ˆë‹¤"
            
            echo "grains-monitor state ì ìš© ì¤‘..."
            timeout 60 sudo salt '*' state.apply grains-monitor || echo "ì¼ë¶€ ì ìš©ì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤. ìˆ˜ë™ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. "
          else
            echo "âš ï¸ ì¼ë¶€ Minion ì—°ê²°ì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤. "
          fi
          
          echo "âœ… ë°°í¬ ì™„ë£Œ"
        ENDSSH
        
    - name: Notify result
      if: always()
      run: |
        if [ "${{ secrets.DOORAY_WEBHOOK }}" != "" ]; then
          STATUS=$([ "${{ job.status }}" == "success" ] && echo "âœ… ì„±ê³µ" || echo "âŒ ì‹¤íŒ¨")
          curl -X POST "${{ secrets.DOORAY_WEBHOOK }}" \
            -H 'Content-type: application/json' \
            --data "{\"text\": \"Salt Grains Monitor ë°°í¬ $STATUS\nì»¤ë°‹: \`${{ github.sha }}\`\nì‹œê°„: $(date)\"}" || true
        fi